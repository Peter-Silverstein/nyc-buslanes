---
title: "data_manipulation_testing"
author: "Peter Silverstein"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(httr)
library(stringr)
library(purrr)
library(rstanarm)
library(sf)
library(jsonlite)
library(geojsonsf)
library(lwgeom)
library(units)
library(zoo)
library(lme4)
```

```{r}
# Getting MTA Bus Speed Data via API

# 2015-2019: https://data.ny.gov/Transportation/MTA-Bus-Speeds-2015-2019/cudb-vcni/about_data
url <- "https://data.ny.gov/resource/cudb-vcni.json?$limit=100000"
res <- GET(url)
df_15_19 <- tibble(fromJSON(content(res, "text"), flatten = TRUE)) %>%
  mutate(date = str_split_fixed(month, "T", 2)[, 1]) %>%
  select(!month) %>%
  mutate(
    day_type = as.numeric(day_type),
    total_operating_time = as.numeric(total_operating_time),
    total_mileage = as.numeric(total_mileage),
    average_speed = as.numeric(average_speed),
    date = as.Date(date)
  )

# 2020-2024: https://data.ny.gov/Transportation/MTA-Bus-Speeds-2020-2024/6ksi-7cxr/about_data
url <- "https://data.ny.gov/resource/6ksi-7cxr.json?$limit=100000"
res <- GET(url)
df_20_24 <- tibble(fromJSON(content(res, "text"), flatten = TRUE)) %>%
  mutate(date = str_split_fixed(month, "T", 2)[, 1]) %>%
  select(!month) %>%
  relocate(total_operating_time, .before = total_mileage) %>%
  mutate(
    day_type = as.numeric(day_type),
    total_operating_time = as.numeric(total_operating_time),
    total_mileage = as.numeric(total_mileage),
    average_speed = as.numeric(average_speed),
    date = as.Date(date)
  )

# 2025: https://data.ny.gov/Transportation/MTA-Bus-Speeds-Beginning-2025/4u4b-jge6/about_data 
url <- "https://data.ny.gov/resource/4u4b-jge6.json?$limit=100000"
res <- GET(url)
df_25 <- tibble(fromJSON(content(res, "text"), flatten = TRUE)) %>%
  mutate(date = str_split_fixed(month, "T", 2)[, 1]) %>%
  select(!month) %>%
  mutate(
    day_type = as.numeric(day_type),
    total_operating_time = as.numeric(total_operating_time),
    total_mileage = as.numeric(total_mileage),
    average_speed = as.numeric(average_speed),
    date = as.Date(date)
  )

df_combined <- rbind(df_15_19, df_20_24, df_25) %>%
  mutate(
    total_mileage = round(total_mileage, 1),
    average_speed = round(average_speed, 2)
    ) %>%
  mutate(
    year = str_split_fixed(date, "-", 3)[, 1],
    month = str_split_fixed(date, "-", 3)[, 2]
  ) %>%
  select(!date)
```

```{r}
df_speeds <- df_combined %>%
  mutate(
    borough = as.factor(borough),
    trip_type = as.factor(trip_type),
    route_id = as.factor(route_id),
    period = as.factor(period),
    date = as.yearmon(paste(year, month), "%Y %m"),
    year = as.factor(year),
    month = as.factor(month),
  )
summary(df_speeds)
```

```{r}
# Loading Bus Lanes - Local Streets: https://data.cityofnewyork.us/Transportation/Bus-Lanes-Local-Streets/ycrg-ses3/about_data 
url <- "https://data.cityofnewyork.us/resource/ycrg-ses3.json?$limit=5000"
res <- GET(url)
local_streets <- fromJSON(content(res, "text"), flatten = TRUE)

# Create GeoJSON strings for each row from the_geom.type and the_geom.coordinates
geojson_strings <- mapply(function(t, coords) {
  toJSON(list(type = t, coordinates = coords), auto_unbox = TRUE)
}, local_streets$the_geom.type, local_streets$the_geom.coordinates)

# Convert each GeoJSON geometry string to sf geometry objects
geoms_sf <- geojsonsf::geojson_sf(paste0('{"type":"Feature","geometry":', geojson_strings, '}'))

# Combine geometries with attributes (dropping original the_geom columns)
bus_lanes_sf <- st_sf(local_streets[, !(names(local_streets) %in% c("the_geom.type", "the_geom.coordinates", "the_geom"))], geometry = geoms_sf$geometry)

# Coordinate reference system likely WGS84
st_crs(bus_lanes_sf) <- 4326

bus_lanes_sf <- bus_lanes_sf %>%
  distinct(segmentid, .keep_all = TRUE)
```

```{r}
# Loading Bus Route Geometries: https://data.ny.gov/Transportation/MTA-Bus-Routes/bzwk-3hb4/explore/query/SELECT%0A%20%20%60valid_from%60%2C%0A%20%20%60valid_to%60%2C%0A%20%20%60route_id%60%2C%0A%20%20%60route_short_name%60%2C%0A%20%20%60route_long_name%60%2C%0A%20%20%60route_description%60%2C%0A%20%20%60trip_type%60%2C%0A%20%20%60route_type%60%2C%0A%20%20%60bundle%60%2C%0A%20%20%60route_color%60%2C%0A%20%20%60direction_id%60%2C%0A%20%20%60direction%60%2C%0A%20%20%60shape_id%60%2C%0A%20%20%60vertices%60%2C%0A%20%20%60shape_length%60%2C%0A%20%20%60min_longitude%60%2C%0A%20%20%60min_latitude%60%2C%0A%20%20%60max_longitude%60%2C%0A%20%20%60max_latitude%60%2C%0A%20%20%60geometry%60%0AWHERE%20%60valid_to%60%20%3E%20%222025-01-01T11%3A13%3A22%22%20%3A%3A%20floating_timestamp%0AORDER%20BY%0A%20%20%60valid_from%60%20DESC%20NULL%20LAST%2C%0A%20%20%60route_id%60%20ASC%20NULL%20LAST%2C%0A%20%20%60valid_to%60%20DESC%20NULL%20LAST/page/filter

route_shapes <- read_csv("../data/MTA_Bus_Routes.csv")
colnames(route_shapes) <- gsub(" ", "_", colnames(route_shapes))

route_shapes <- route_shapes %>%
  filter(Route_Type %in% c("Local", "Express", "SBS")) %>%
  filter(Route_ID %in% unique(df_combined$route_id))

route_shapes$Geometry <- st_as_sfc(route_shapes$Geometry, crs=4326)
invalid = !st_is_valid(route_shapes$Geometry)
if (any(invalid)) {
  route_shapes$Geometry[invalid] <- st_make_valid(route_shapes$Geometry[invalid])
}
route_shapes_sf <- st_sf(route_shapes)
```

```{r}
# Merging Route Shapes to 1 per Route_ID, Direction
threshold <- 50  # distance threshold in CRS units, e.g., meters

merged_routes_list <- route_shapes %>%
  group_by(Route_ID, Direction) %>%
  group_map(~ {
    dist_matrix <- st_distance(.x$Geometry)
    hc <- hclust(as.dist(dist_matrix))
    clusters <- cutree(hc, h = threshold)
    
    .x$cluster <- clusters

    .x %>%
      group_by(cluster) %>%
      summarize(
        Route_ID = first(Route_ID),
        Direction = first(Direction),
        geometry = st_union(Geometry),
        .groups = "drop"
      )
  }, .keep = TRUE)

merged_routes <- do.call(rbind, merged_routes_list)
merged_routes <- st_as_sf(merged_routes)

merged_routes <- merged_routes %>%
  group_by(Route_ID) %>%
  summarize(geometry = st_union(geometry)) %>%
  ungroup()
```

```{r}
# Showing that lower bound of segment length for lanes is 25 feet, so that'll be the minimum intersection distance
bus_lanes_sf_reproj2263 <- st_transform(bus_lanes_sf, 2263)
bus_lanes_sf_reproj2263$length <- st_length(bus_lanes_sf_reproj2263$geometry)

filt = bus_lanes_sf_reproj2263 %>%
  filter(length < set_units(250, "ft"))
hist(filt$length, breaks = 100)
```

```{r}
# Intersect Bus Routes and Bus Lanes

# Initial intersection
line_intersections <- st_intersection(bus_lanes_sf, merged_routes)

# Convert MULTIPOINT to LINESTRING function
convert_multipoint_to_linestring <- function(geom) {
  if (inherits(geom, "MULTIPOINT")) {
    combined_geom <- st_combine(geom)
    ls <- st_cast(combined_geom, "LINESTRING")
    return(ls[[1]])  # extract the sfg LINESTRING, not a list
  }
  return(geom)
}

new_geoms <- lapply(line_intersections$geometry, convert_multipoint_to_linestring)

# 'new_geoms' is now a list of individual sfg objects suitable for st_sfc()
new_geoms_sfc <- st_sfc(new_geoms, crs = st_crs(line_intersections))

st_geometry(line_intersections) <- new_geoms_sfc

line_intersections <- st_transform(line_intersections, 2263)

# Compute length on updated geometries
line_intersections$length_ft <- st_length(line_intersections)

# Filter by minimum length 25 feet
filtered_intersections_25 <- line_intersections[line_intersections$length_ft >= set_units(25, "ft"), ]
```

```{r}
# Cleaning up Intersection DF
intersection_cleaned <- filtered_intersections_25 %>%
  select(boro, hours, days, lane_type1, open_dates, Route_ID, length_ft) %>%
  mutate(open_date_str = sapply(str_split(open_dates, ","), `[`, 1)) %>%
  mutate(open_date = parse_date_time(open_date_str, orders = c("%m/%d/%Y", "%m/%d/%y"))) %>%
  select(-open_date_str, -open_dates) %>%
  filter(!is.na(open_date)) %>%
  st_drop_geometry() %>%
  arrange(Route_ID, open_date)
```

```{r}
# Aggregating bus lanes to date opened, NOTE THAT LOST SOME LANE CHARACTERISTICS
intersection_final <- intersection_cleaned %>%
  group_by(Route_ID, open_date) %>%
  summarize(tot_buslane_ft = sum(length_ft))

intersection_final <- intersection_final %>%
  arrange(Route_ID, open_date) %>%
  mutate(tot_buslane_ft = as.numeric(tot_buslane_ft)) %>%
  filter(tot_buslane_ft > 100)

# Filtering for Post-Pandemic
intersection_postpandemic <- intersection_final %>%
  filter(open_date > as.Date("2021-12-31"))
```

```{r}
# Joining intersection_final to df_speeds
df_complete <- df_speeds %>%
  left_join(intersection_final, by = join_by(route_id == Route_ID)) %>%
  mutate(date = as.Date(date)) %>%
  mutate(treatment = case_when(
    open_date < date ~ 1,
    TRUE ~ 0
  ))
```





---
title: "data_visualization"
author: "Peter Silverstein"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(tmap)
library(httr)
library(sf)
library(units)
library(spatstat)
library(raster)
```

```{r}
# Bus routes along corridor
# Loading Bus Route Geometries: https://data.ny.gov/Transportation/MTA-Bus-Routes/bzwk-3hb4/explore/query/SELECT%0A%20%20%60valid_from%60%2C%0A%20%20%60valid_to%60%2C%0A%20%20%60route_id%60%2C%0A%20%20%60route_short_name%60%2C%0A%20%20%60route_long_name%60%2C%0A%20%20%60route_description%60%2C%0A%20%20%60trip_type%60%2C%0A%20%20%60route_type%60%2C%0A%20%20%60bundle%60%2C%0A%20%20%60route_color%60%2C%0A%20%20%60direction_id%60%2C%0A%20%20%60direction%60%2C%0A%20%20%60shape_id%60%2C%0A%20%20%60vertices%60%2C%0A%20%20%60shape_length%60%2C%0A%20%20%60min_longitude%60%2C%0A%20%20%60min_latitude%60%2C%0A%20%20%60max_longitude%60%2C%0A%20%20%60max_latitude%60%2C%0A%20%20%60geometry%60%0AWHERE%20%60valid_to%60%20%3E%20%222025-01-01T11%3A13%3A22%22%20%3A%3A%20floating_timestamp%0AORDER%20BY%0A%20%20%60valid_from%60%20DESC%20NULL%20LAST%2C%0A%20%20%60route_id%60%20ASC%20NULL%20LAST%2C%0A%20%20%60valid_to%60%20DESC%20NULL%20LAST/page/filter

route_shapes <- read_csv("../data/MTA_Bus_Routes.csv")
colnames(route_shapes) <- gsub(" ", "_", colnames(route_shapes))

route_shapes <- route_shapes %>%
  filter(Route_Type %in% c("Local", "Express", "SBS"))
  
route_shapes$Geometry <- st_as_sfc(route_shapes$Geometry, crs=4326)
invalid = !st_is_valid(route_shapes$Geometry)
if (any(invalid)) {
  route_shapes$Geometry[invalid] <- st_make_valid(route_shapes$Geometry[invalid])
}
route_shapes_sf <- st_sf(route_shapes)

# Merging Route Shapes
# Transform CRS for accurate length measurement (using NYC feet CRS as example)
route_shapes_proj <- st_transform(route_shapes_sf, 2263)  

# Group by Route_ID only to combine both directions
merged_routes_both_directions <- route_shapes_proj %>%
  group_by(Route_ID) %>%
  summarize(geometry = st_union(Geometry), .groups = "drop") %>%
  # Simplify geometries to dissolve minor overlaps and clean up
  mutate(geometry = st_simplify(geometry, dTolerance = set_units(10, "ft"))) %>%
  # Check and fix invalid geometries
  mutate(geometry = if_else(!st_is_valid(geometry), st_make_valid(geometry), geometry))

# Calculate total length per route, which now covers both directions combined
merged_routes <- merged_routes_both_directions %>%
  mutate(total_length_ft = st_length(geometry))

bus_routes_proj <- st_transform(merged_routes, 2263)
```

```{r}
# Subway presence
# Loading Subway Stops: https://data.ny.gov/Transportation/MTA-Subway-Stations/39hk-dx4f/about_data
url <- "https://data.ny.gov/resource/39hk-dx4f.json?$limit=5000"
res <- GET(url)
if (status_code(res) != 200) {
  stop("Request failed with status: ", status_code(res))
}
subway_stops <- fromJSON(content(res, "text"), flatten = TRUE) %>%
  select(gtfs_stop_id, gtfs_longitude, gtfs_latitude)

subway_stops_sf <- st_as_sf(
  subway_stops,
  coords = c("gtfs_longitude", "gtfs_latitude"),
  crs = 4326,
  remove = FALSE
)

subway_stops_reproj <- st_transform(subway_stops_sf, 2263)
```

```{r}
# Existing bus lanes
# Loading Bus Lanes - Local Streets: https://data.cityofnewyork.us/Transportation/Bus-Lanes-Local-Streets/ycrg-ses3/about_data 
url <- "https://data.cityofnewyork.us/resource/ycrg-ses3.json?$limit=5000"
res <- GET(url)
if (status_code(res) != 200) {
  stop("Request failed with status: ", status_code(res))
}
local_streets <- fromJSON(content(res, "text"), flatten = TRUE)

# Create GeoJSON strings for each row from the_geom.type and the_geom.coordinates
geojson_strings <- mapply(function(t, coords) {
  toJSON(list(type = t, coordinates = coords), auto_unbox = TRUE)
}, local_streets$the_geom.type, local_streets$the_geom.coordinates)

# Convert each GeoJSON geometry string to sf geometry objects
geoms_sf <- geojsonsf::geojson_sf(paste0('{"type":"Feature","geometry":', geojson_strings, '}'))

# Combine geometries with attributes (dropping original the_geom columns)
bus_lanes_sf <- st_sf(local_streets[, !(names(local_streets) %in% c("the_geom.type", "the_geom.coordinates", "the_geom"))], geometry = geoms_sf$geometry)

# Coordinate reference system likely WGS84
st_crs(bus_lanes_sf) <- 4326

bus_lanes_sf <- bus_lanes_sf %>%
  distinct(segmentid, .keep_all = TRUE)

bus_lanes_proj <- st_transform(bus_lanes_sf, 2263)
```

```{r}
# Existing lane count
lion <- st_read("../data/lion.gdb", layer = "lion")
lion_proj <- st_transform(lion, 2263)
```

Next: KDE Map of Routes for exploration
```{r}
bus_routes_proj_clean <- bus_routes_proj %>%
  st_cast("LINESTRING") %>%           
  filter(st_is_valid(geometry), 
         st_length(geometry) > set_units(0, "ft")) 

bus_route_points <- st_line_sample(bus_routes_proj_clean, density = 1/100)

points_sf <- st_sf(geometry = st_cast(bus_route_points, "POINT"))

# Convert points to spatstat point pattern (ppp) object
bbox <- st_bbox(points_sf)
win <- spatstat.geom::owin(xrange = c(bbox["xmin"], bbox["xmax"]), yrange = c(bbox["ymin"], bbox["ymax"]))
ppp_points <- spatstat.geom::ppp(st_coordinates(points_sf)[,1], st_coordinates(points_sf)[,2], window=win)

# Calculate kernel density estimate raster
kde_raster <- spatstat.explore::density.ppp(ppp_points, sigma=500, at="pixels", eps=c(50,50))

# Convert spatstat density object to raster
kde_r <- raster::raster(kde_raster)

# Optional: Transform raster CRS to 2263 if needed
crs(kde_r) <- "+init=EPSG:2263"

# Plot KDE raster with tmap
tm_shape(kde_r) + tm_raster(palette = "YlOrRd", title = "Route Density") +
  tm_shape(points_sf) + tm_dots(size = 0.1, col = "blue") +
  tm_layout(title = "Bus Route KDE")
```


Possible ideas if too many options
1. select shorter routes


```{r}
# Load in data
df <- read_csv("../data/final_modeling_data.csv")
df <- df %>%
  filter(year > 2021) %>%
  mutate(year = year - 2021) %>%
  filter(peak == 1)
```

```{r}
plot <- ggplot(data = df, aes(x = lane_perc, y = average_speed)) + 
  geom_point() + 
  geom_smooth(
    method = "loess",
    method.args = list(span = 0.1, degree = 2)
  )

plot
```

